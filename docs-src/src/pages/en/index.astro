---
import Layout from "../../layouts/Layout.astro";
import Hero from "../../components/Hero.astro";
import Section from "../../components/Section.astro";
import StatsCard from "../../components/StatsCard.astro";
import StatsGrid from "../../components/StatsGrid.astro";
import CategoryGrid from "../../components/CategoryGrid.astro";
import StyleGrid from "../../components/StyleGrid.svelte";
import TrendChart from "../../components/TrendChart.svelte";
import type { PageData } from "../../types";
import { useTranslation, type Locale } from "../../i18n";

const locale: Locale = "en";
const t = useTranslation(locale);

// Load data from JSON files (generated by CI)
let data: PageData;

try {
  const dataFile = await import("../../../public/data.json");
  data = dataFile.default as PageData;
} catch {
  // Fallback for local development
  data = {
    csl: { total: 0, passed: 0, failed: 0, styles: [] },
    citeproc: { total: 0, compiled: 0, errors: 0, categories: [] },
    benchmark: { runs: [], styles: [] },
    buildTime: new Date().toISOString(),
  };
}

const citeprocRate =
  data.citeproc.total > 0
    ? ((data.citeproc.compiled / data.citeproc.total) * 100).toFixed(1)
    : "0";

const cslRate =
  data.csl.total > 0
    ? ((data.csl.passed / data.csl.total) * 100).toFixed(1)
    : "0";

const heroStats = [
  { label: t.stats.cslStyles, value: `${data.csl.passed}/${data.csl.total}` },
  {
    label: t.stats.testCases,
    value: `${data.citeproc.compiled}/${data.citeproc.total}`,
  },
  { label: t.stats.benchmarkStyles, value: String(data.benchmark.styles.length) },
];
---

<Layout title={t.meta.title} lang={t.meta.lang} locale={locale}>
  <Hero
    locale={locale}
    title={t.hero.title}
    description={t.hero.description}
    stats={heroStats}
  />

  <!-- citeproc-js Test Suite Section -->
  <Section
    title={t.sections.citeproc.title}
    icon="ðŸ“‹"
    note={t.sections.citeproc.note}
  >
    <p slot="description" class="text-muted-foreground text-sm mb-4">
      {t.sections.citeproc.description}
      <a
        href="https://github.com/Juris-M/citeproc-js"
        class="text-primary hover:underline"
        target="_blank"
        rel="noopener noreferrer"
      >
        citeproc-js
      </a>
    </p>

    <StatsGrid>
      <StatsCard value={data.citeproc.total} label={t.stats.total} />
      <StatsCard
        value={data.citeproc.compiled}
        label={t.stats.compiled}
        variant="success"
      />
      <StatsCard
        value={data.citeproc.errors}
        label={t.stats.errors}
        variant="warning"
      />
      <StatsCard value={`${citeprocRate}%`} label={t.stats.passRate} />
    </StatsGrid>

    <CategoryGrid locale={locale} categories={data.citeproc.categories} />
  </Section>

  <!-- CSL Styles Section -->
  <Section title={t.sections.csl.title} icon="ðŸ“š" note={t.sections.csl.note}>
    <p slot="description" class="text-muted-foreground text-sm mb-4">
      {t.sections.csl.description}
      <a
        href="https://github.com/zotero-chinese/styles"
        class="text-primary hover:underline"
        target="_blank"
        rel="noopener noreferrer"
      >
        zotero-chinese/styles
      </a>
    </p>

    <StatsGrid>
      <StatsCard value={data.csl.total} label={t.stats.totalStyles} />
      <StatsCard
        value={data.csl.passed}
        label={t.stats.compiled}
        variant="success"
      />
      <StatsCard
        value={data.csl.failed}
        label={t.stats.failed}
        variant="warning"
      />
      <StatsCard value={`${cslRate}%`} label={t.stats.passRate} />
    </StatsGrid>

    <StyleGrid client:load styles={data.csl.styles} t={t.styleGrid} />
  </Section>

  <!-- Benchmark Section -->
  <Section title={t.sections.benchmark.title} icon="ðŸ“ˆ">
    <p slot="description" class="text-muted-foreground text-sm mb-4">
      {t.sections.benchmark.description}
    </p>

    <TrendChart client:load history={data.benchmark} t={t.chart} />
  </Section>

  <footer
    class="mt-4 pt-4 border-t border-border text-muted-foreground text-xs sm:text-sm text-center"
  >
    <div
      class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2"
    >
      <span>{t.footer.buildTime}: {data.buildTime}</span>
      <span class="hidden sm:inline">Â·</span>
      <a
        href="https://github.com/pku-typst/citeproc-typst"
        class="text-primary hover:underline"
        target="_blank"
        rel="noopener noreferrer"
      >
        GitHub
      </a>
    </div>
  </footer>
</Layout>
