---
import Layout from "../layouts/Layout.astro";
import Hero from "../components/Hero.astro";
import Section from "../components/Section.astro";
import StatsCard from "../components/StatsCard.astro";
import StatsGrid from "../components/StatsGrid.astro";
import CategoryGrid from "../components/CategoryGrid.astro";
import StyleGrid from "../components/StyleGrid.svelte";
import TrendChart from "../components/TrendChart.svelte";
import type { PageData } from "../types";

// Load data from JSON files (generated by CI)
let data: PageData;

try {
  const dataFile = await import("../../public/data.json");
  data = dataFile.default as PageData;
} catch {
  // Fallback for local development
  data = {
    csl: { total: 0, passed: 0, failed: 0, styles: [] },
    citeproc: { total: 0, compiled: 0, errors: 0, categories: [] },
    benchmark: { runs: [], styles: [] },
    buildTime: new Date().toISOString(),
  };
}

const citeprocRate =
  data.citeproc.total > 0
    ? ((data.citeproc.compiled / data.citeproc.total) * 100).toFixed(1)
    : "0";

const cslRate =
  data.csl.total > 0
    ? ((data.csl.passed / data.csl.total) * 100).toFixed(1)
    : "0";

const heroStats = [
  { label: "CSL æ ·å¼", value: `${data.csl.passed}/${data.csl.total}` },
  { label: "æµ‹è¯•ç”¨ä¾‹", value: `${data.citeproc.compiled}/${data.citeproc.total}` },
  { label: "Benchmark æ ·å¼", value: String(data.benchmark.styles.length) },
];
---

<Layout title="citeproc-typst å…¼å®¹æ€§æµ‹è¯•">
  <Hero
    title="ğŸ”¬ citeproc-typst"
    description="CSL (Citation Style Language) å¤„ç†å™¨çš„ Typst åŸç”Ÿå®ç°ã€‚æ”¯æŒå­¦æœ¯æ–‡çŒ®å¼•ç”¨æ ¼å¼åŒ–ï¼Œå…¼å®¹ Zotero ç­‰å·¥å…·çš„ CSL æ ·å¼ã€‚"
    stats={heroStats}
  />

  <!-- citeproc-js Test Suite Section -->
  <Section
    title="citeproc-js æµ‹è¯•å¥—ä»¶"
    icon="ğŸ“‹"
    note="ç¼–è¯‘é€šè¿‡ä»…è¡¨ç¤º citeproc-typst èƒ½å¤Ÿå¤„ç†è¯¥æµ‹è¯•ç”¨ä¾‹ï¼Œä¸ä¿è¯è¾“å‡ºç»“æœä¸ citeproc-js å®Œå…¨ä¸€è‡´ã€‚"
  >
    <p slot="description" class="text-muted-foreground text-sm mb-4">
      ä½¿ç”¨
      <a
        href="https://github.com/Juris-M/citeproc-js"
        class="text-primary hover:underline"
        target="_blank"
        rel="noopener noreferrer"
      >
        citeproc-js
      </a>
      æµ‹è¯•å¥—ä»¶ä¸­çš„ CSL æ ·å¼å’Œæ•°æ®è¿›è¡Œç¼–è¯‘æµ‹è¯•ã€‚
    </p>

    <StatsGrid>
      <StatsCard value={data.citeproc.total} label="æ€»æµ‹è¯•æ•°" />
      <StatsCard
        value={data.citeproc.compiled}
        label="ç¼–è¯‘é€šè¿‡"
        variant="success"
      />
      <StatsCard
        value={data.citeproc.errors}
        label="ç¼–è¯‘é”™è¯¯"
        variant="warning"
      />
      <StatsCard value={`${citeprocRate}%`} label="é€šè¿‡ç‡" />
    </StatsGrid>

    <CategoryGrid categories={data.citeproc.categories} />
  </Section>

  <!-- CSL Styles Section -->
  <Section
    title="CSL æ ·å¼å…¼å®¹æ€§"
    icon="ğŸ“š"
    note="ç¼–è¯‘é€šè¿‡ä»…è¡¨ç¤º citeproc-typst èƒ½å¤Ÿè§£æå¹¶å¤„ç†è¯¥æ ·å¼ï¼Œä¸ä¿è¯è¾“å‡ºæ ¼å¼å®Œå…¨ç¬¦åˆé¢„æœŸã€‚"
  >
    <p slot="description" class="text-muted-foreground text-sm mb-4">
      æµ‹è¯•
      <a
        href="https://github.com/zotero-chinese/styles"
        class="text-primary hover:underline"
        target="_blank"
        rel="noopener noreferrer"
      >
        zotero-chinese/styles
      </a>
      ä¸­çš„æ‰€æœ‰ CSL æ ·å¼æ˜¯å¦å¯ä»¥æ­£å¸¸ç¼–è¯‘ã€‚
    </p>

    <StatsGrid>
      <StatsCard value={data.csl.total} label="æ€»æ ·å¼æ•°" />
      <StatsCard value={data.csl.passed} label="ç¼–è¯‘é€šè¿‡" variant="success" />
      <StatsCard value={data.csl.failed} label="ç¼–è¯‘å¤±è´¥" variant="warning" />
      <StatsCard value={`${cslRate}%`} label="é€šè¿‡ç‡" />
    </StatsGrid>

    <StyleGrid client:load styles={data.csl.styles} />
  </Section>

  <!-- Benchmark Section -->
  <Section
    title="æ€§èƒ½è¶‹åŠ¿"
    icon="ğŸ“ˆ"
  >
    <p slot="description" class="text-muted-foreground text-sm mb-4">
      è¿½è¸ªä»£è¡¨æ€§ CSL æ ·å¼çš„ç¼–è¯‘æ—¶é—´å˜åŒ–ï¼Œç”¨äºæ£€æµ‹æ€§èƒ½å›å½’ã€‚
    </p>

    <TrendChart client:load history={data.benchmark} />
  </Section>

  <footer
    class="mt-4 pt-4 border-t border-border text-muted-foreground text-xs sm:text-sm text-center"
  >
    <div class="flex flex-col sm:flex-row items-center justify-center gap-1 sm:gap-2">
      <span>æ„å»ºæ—¶é—´: {data.buildTime}</span>
      <span class="hidden sm:inline">Â·</span>
      <a
        href="https://github.com/lucifer1004/citeproc-typst"
        class="text-primary hover:underline"
        target="_blank"
        rel="noopener noreferrer"
      >
        GitHub
      </a>
    </div>
  </footer>
</Layout>
