---
import Layout from "../layouts/Layout.astro";
import StatsCard from "../components/StatsCard.astro";
import StatsGrid from "../components/StatsGrid.astro";
import CategoryGrid from "../components/CategoryGrid.astro";
import StyleGrid from "../components/StyleGrid.svelte";
import TrendChart from "../components/TrendChart.svelte";
import type { PageData } from "../types";

// Load data from JSON files (generated by CI)
let data: PageData;

try {
  const dataFile = await import("../../public/data.json");
  data = dataFile.default as PageData;
} catch {
  // Fallback for local development
  data = {
    csl: { total: 0, passed: 0, failed: 0, styles: [] },
    citeproc: { total: 0, compiled: 0, errors: 0, categories: [] },
    benchmark: { runs: [], styles: [] },
    buildTime: new Date().toISOString(),
  };
}

const citeprocRate =
  data.citeproc.total > 0
    ? ((data.citeproc.compiled / data.citeproc.total) * 100).toFixed(1)
    : "0";

const cslRate =
  data.csl.total > 0
    ? ((data.csl.passed / data.csl.total) * 100).toFixed(1)
    : "0";
---

<Layout title="citeproc-typst 兼容性测试">
  <h1 class="text-3xl font-bold mb-2">🔬 citeproc-typst 兼容性测试</h1>
  <p class="text-muted-foreground mb-8">
    CSL (Citation Style Language) 处理器的 Typst 实现
  </p>

  <!-- citeproc-js Test Suite Section -->
  <h2 class="text-xl font-semibold mt-10 mb-4 pb-2 border-b-2 border-border">
    📋 citeproc-js 测试套件
  </h2>
  <p class="text-muted-foreground mb-4">
    使用
    <a href="https://github.com/Juris-M/citeproc-js" class="text-primary hover:underline">
      citeproc-js
    </a>
    测试套件中的 CSL 样式和数据进行编译测试。
    <br />
    <small class="text-muted-foreground">
      注：编译通过仅表示 citeproc-typst 能够处理该测试用例，不保证输出结果与
      citeproc-js 完全一致。
    </small>
  </p>

  <StatsGrid>
    <StatsCard value={data.citeproc.total} label="总测试数" />
    <StatsCard
      value={data.citeproc.compiled}
      label="编译通过"
      variant="success"
    />
    <StatsCard value={data.citeproc.errors} label="编译错误" variant="warning" />
    <StatsCard value={`${citeprocRate}%`} label="编译通过率" />
  </StatsGrid>

  <CategoryGrid categories={data.citeproc.categories} />

  <!-- CSL Styles Section -->
  <h2 class="text-xl font-semibold mt-10 mb-4 pb-2 border-b-2 border-border">
    📚 CSL 样式兼容性
  </h2>
  <p class="text-muted-foreground mb-4">
    测试
    <a href="https://github.com/zotero-chinese/styles" class="text-primary hover:underline">
      zotero-chinese/styles
    </a>
    中的所有 CSL 样式是否可以正常编译。
    <br />
    <small class="text-muted-foreground">
      注：编译通过仅表示 citeproc-typst
      能够解析并处理该样式，不保证输出格式完全符合预期。
    </small>
  </p>

  <StatsGrid>
    <StatsCard value={data.csl.total} label="总样式数" />
    <StatsCard value={data.csl.passed} label="编译通过" variant="success" />
    <StatsCard value={data.csl.failed} label="编译失败" variant="warning" />
    <StatsCard value={`${cslRate}%`} label="编译通过率" />
  </StatsGrid>

  <StyleGrid client:load styles={data.csl.styles} />

  <!-- Benchmark Section -->
  <h2 class="text-xl font-semibold mt-10 mb-4 pb-2 border-b-2 border-border">
    📈 性能趋势
  </h2>
  <p class="text-muted-foreground mb-4">
    追踪代表性 CSL 样式的编译时间变化（单位：毫秒）
  </p>

  <TrendChart client:load history={data.benchmark} />

  <footer class="mt-8 pt-4 border-t border-border text-muted-foreground text-sm text-center">
    构建时间: {data.buildTime} ·
    <a href="https://github.com/lucifer1004/citeproc-typst" class="text-primary hover:underline">
      GitHub
    </a>
  </footer>
</Layout>
