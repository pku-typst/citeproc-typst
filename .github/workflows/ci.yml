name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # CSL compatibility test with all zotero-chinese/styles
  csl-compatibility:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Clone zotero-chinese/styles
        run: |
          git clone --depth 1 https://github.com/zotero-chinese/styles.git zotero-styles

      - name: Setup Typst
        uses: typst-community/setup-typst@v4

      - name: Run CSL compatibility tests
        id: csl-test
        run: |
          mkdir -p docs/results

          # Find all CSL files
          CSL_FILES=$(find zotero-styles/src -name "*.csl" | sort)
          TOTAL=$(echo "$CSL_FILES" | wc -l | tr -d ' ')

          echo "Found $TOTAL CSL files to test"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Counters
          PASSED=0
          FAILED=0

          # Test each CSL file
          while IFS= read -r csl_file; do
            NAME=$(basename "$csl_file" .csl)
            # Replace problematic characters (space and slash) for URL safety
            SAFE_NAME=$(echo "$NAME" | tr ' /' '__')

            # Run typst compile and save PDF
            if typst compile tests/test-csl-compatibility.typ "docs/results/${SAFE_NAME}.pdf" \
                 --root . \
                 --font-path fonts/ \
                 --input "csl=$csl_file" 2>/dev/null; then
              echo "âœ“ $NAME"
              PASSED=$((PASSED + 1))
            else
              echo "âœ— $NAME"
              FAILED=$((FAILED + 1))
            fi
          done <<< "$CSL_FILES"

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # Summary
          echo ""
          echo "========================================"
          echo "Summary: $PASSED/$TOTAL passed ($FAILED failed)"
          echo "========================================"

          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED CSL styles failed compatibility test"
            exit 1
          fi

      - name: Generate index page
        run: |
          TOTAL=${{ steps.csl-test.outputs.total }}
          PASSED=${{ steps.csl-test.outputs.passed }}
          FAILED=${{ steps.csl-test.outputs.failed }}
          PASS_RATE=$(echo "scale=1; $PASSED * 100 / $TOTAL" | bc)
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Copy template
          cp .github/pages/index.html docs/index.html

          # Generate styles list HTML
          STYLES_HTML=""
          for pdf in $(ls docs/results/*.pdf 2>/dev/null | sort); do
            NAME=$(basename "$pdf" .pdf | tr '_' ' ')
            STYLES_HTML="${STYLES_HTML}    <a href=\"results/$(basename "$pdf")\" class=\"style-link\">ðŸ“„ ${NAME}</a>\n"
          done

          # Replace placeholders
          sed -i "s/{{TOTAL}}/$TOTAL/g" docs/index.html
          sed -i "s/{{PASSED}}/$PASSED/g" docs/index.html
          sed -i "s/{{FAILED}}/$FAILED/g" docs/index.html
          sed -i "s/{{RATE}}/$PASS_RATE/g" docs/index.html
          sed -i "s/{{BUILD_TIME}}/$BUILD_TIME/g" docs/index.html
          sed -i "s|{{STYLES_LIST}}|${STYLES_HTML}|g" docs/index.html

      - name: Create job summary
        run: |
          echo "## CSL Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Styles | ${{ steps.csl-test.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.csl-test.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.csl-test.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs

  # Deploy to GitHub Pages (only on main branch push)
  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: csl-compatibility
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
