name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  # citeproc-js test suite compatibility (runs in parallel with csl-compatibility)
  citeproc-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Clone citeproc-js
        run: |
          mkdir -p references
          git clone --depth 1 https://github.com/Juris-M/citeproc-js.git references/citeproc-js

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Setup Typst
        uses: typst-community/setup-typst@v4

      - name: Run citeproc-js tests
        id: citeproc-test
        run: |
          python scripts/run-citeproc-tests.py

          # Parse results from markdown report
          TOTAL=$(grep -oP 'Total Tests:\*\* \K\d+' build/citeproc-compatibility-report.md || echo "0")
          COMPILED=$(grep -oP '\| compiled \| \K\d+' build/citeproc-compatibility-report.md || echo "0")
          ERRORS=$(grep -oP '\| error \| \K\d+' build/citeproc-compatibility-report.md || echo "0")

          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "compiled=$COMPILED" >> $GITHUB_OUTPUT
          echo "errors=$ERRORS" >> $GITHUB_OUTPUT

          # Extract category breakdown as JSON
          python3 -c "
          import re
          import json

          with open('build/citeproc-compatibility-report.md') as f:
              content = f.read()

          # Find category table
          pattern = r'\| (\w+) \| (\d+) \| (\d+) \| (\d+) \| (\d+) \|'
          categories = []
          for match in re.finditer(pattern, content):
              categories.append({
                  'name': match.group(1),
                  'total': int(match.group(2)),
                  'compiled': int(match.group(3))
              })

          with open('build/citeproc-categories.json', 'w') as f:
              json.dump(categories, f)
          "

      - name: Upload compatibility report
        uses: actions/upload-artifact@v4
        with:
          name: citeproc-compatibility-report
          path: |
            build/citeproc-compatibility-report.md
            build/citeproc-categories.json

      - name: Create job summary
        run: |
          echo "## citeproc-js Test Suite Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat build/citeproc-compatibility-report.md >> $GITHUB_STEP_SUMMARY

    outputs:
      total: ${{ steps.citeproc-test.outputs.total }}
      compiled: ${{ steps.citeproc-test.outputs.compiled }}
      errors: ${{ steps.citeproc-test.outputs.errors }}

  # CSL compatibility test with all zotero-chinese/styles (runs in parallel with citeproc-tests)
  csl-compatibility:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Clone zotero-chinese/styles
        run: |
          git clone --depth 1 https://github.com/zotero-chinese/styles.git zotero-chinese-styles

      - name: Setup Typst
        uses: typst-community/setup-typst@v4

      - name: Run CSL compatibility tests
        id: csl-test
        run: |
          mkdir -p build/csl-results

          # Find all CSL files
          CSL_FILES=$(find zotero-chinese-styles/src -name "*.csl" | sort)
          TOTAL=$(echo "$CSL_FILES" | wc -l | tr -d ' ')

          echo "Found $TOTAL CSL files to test"
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Counters
          PASSED=0
          FAILED=0

          # Test each CSL file
          while IFS= read -r csl_file; do
            NAME=$(basename "$csl_file" .csl)
            # Replace problematic characters (space and slash) for URL safety
            SAFE_NAME=$(echo "$NAME" | tr ' /' '__')

            # Run typst compile and save PDF
            if typst compile tests/csl-compatibility/test.typ "build/csl-results/${SAFE_NAME}.pdf" \
                 --root . \
                 --font-path fonts/ \
                 --input "csl=$csl_file" 2>/dev/null; then
              echo "✓ $NAME"
              PASSED=$((PASSED + 1))
            else
              echo "✗ $NAME"
              FAILED=$((FAILED + 1))
            fi
          done <<< "$CSL_FILES"

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          # Summary
          echo ""
          echo "========================================"
          echo "Summary: $PASSED/$TOTAL passed ($FAILED failed)"
          echo "========================================"

          if [ "$FAILED" -gt 0 ]; then
            echo "::error::$FAILED CSL styles failed compatibility test"
            exit 1
          fi

      - name: Upload CSL test results
        uses: actions/upload-artifact@v4
        with:
          name: csl-test-results
          path: build/csl-results/

      - name: Create job summary
        run: |
          echo "## CSL Compatibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total Styles | ${{ steps.csl-test.outputs.total }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.csl-test.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.csl-test.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY

    outputs:
      total: ${{ steps.csl-test.outputs.total }}
      passed: ${{ steps.csl-test.outputs.passed }}
      failed: ${{ steps.csl-test.outputs.failed }}

  # Generate GitHub Pages (after both test jobs complete)
  generate-pages:
    needs: [citeproc-tests, csl-compatibility]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Download citeproc results
        uses: actions/download-artifact@v4
        with:
          name: citeproc-compatibility-report
          path: build/

      - name: Download CSL test results
        uses: actions/download-artifact@v4
        with:
          name: csl-test-results
          path: docs/results/

      - name: Generate index page
        run: |
          python scripts/generate-pages.py \
            --csl-total ${{ needs.csl-compatibility.outputs.total }} \
            --csl-passed ${{ needs.csl-compatibility.outputs.passed }} \
            --csl-failed ${{ needs.csl-compatibility.outputs.failed }} \
            --citeproc-total ${{ needs.citeproc-tests.outputs.total }} \
            --citeproc-compiled ${{ needs.citeproc-tests.outputs.compiled }} \
            --citeproc-errors ${{ needs.citeproc-tests.outputs.errors }} \
            --results-dir docs/results \
            --categories-file build/citeproc-categories.json \
            --template .github/pages/index.html \
            --output docs/index.html

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs

  # Deploy to GitHub Pages (only on main branch push)
  deploy:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: generate-pages
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
